<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Hub Pro V6.4</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--primary); }
        .sidebar { background: white; border-bottom: 2px solid #ddd; padding: 10px; display: flex; gap: 10px; overflow-x: auto; position: sticky; top: 0; z-index: 1000; align-items: center; }
        .subject-tab { padding: 8px 15px; background: #eee; border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: bold; font-size: 0.8rem; border: 2px solid transparent; display: flex; align-items: center; gap: 5px; }
        .subject-tab.active { background: var(--accent); color: white; border-color: var(--primary); }
        .edit-sub-btn { cursor: pointer; font-size: 0.7rem; opacity: 0.7; }
        .add-subject-btn { background: var(--success); color: white; border-radius: 50%; width: 30px; height: 30px; border: none; cursor: pointer; font-weight: bold; flex-shrink: 0; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .inner-nav { display: flex; justify-content: space-around; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .inner-nav-item { padding: 10px; cursor: pointer; font-size: 0.75rem; font-weight: bold; color: #7f8c8d; }
        .inner-nav-item.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .hidden { display: none; }
        .btn { border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-top: 5px; }
        .valutazione-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .btn-valutazione { font-size: 0.6rem; padding: 8px 2px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .history-item { display: flex; flex-direction: column; padding: 10px; border-bottom: 1px solid #eee; gap: 5px; }
        .calendar-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="sidebar" id="subjectBar">
    <button class="add-subject-btn" onclick="promptNewSubject()">+</button>
</div>

<div id="appContent" class="container">
    <div id="noSubject" class="card" style="text-align: center;">
        <h2>Benvenuta!</h2>
        <p>Aggiungi una materia per iniziare.</p>
    </div>

    <div id="subjectTemplate" class="hidden">
        <button class="btn" style="background:var(--danger); margin-bottom:15px;" onclick="applyImprevisto()">‚ö†Ô∏è GESTISCI IMPREVISTO (+1g)</button>
        
        <div class="inner-nav">
            <div class="inner-nav-item active" onclick="switchSubTab(this, 'study')">STUDIO</div>
            <div class="inner-nav-item" onclick="switchSubTab(this, 'ripasso')">RIPASSO</div>
            <div class="inner-nav-item" onclick="switchSubTab(this, 'calendar')">CALENDARIO</div>
            <div class="inner-nav-item" onclick="switchSubTab(this, 'history')">DATI</div>
        </div>

        <div class="sub-tab-content" data-type="study">
            <div class="card">
                <h3>Nuovo Argomento</h3>
                <input type="text" class="topicInput" placeholder="Cosa hai studiato?">
                <button class="btn" style="background:var(--primary)" onclick="addTopic()">Registra Studio</button>
            </div>
        </div>

        <div class="sub-tab-content hidden" data-type="ripasso">
            <div class="card">
                <h3>Da Ripetere Oggi</h3>
                <div class="ripassoList"></div>
            </div>
        </div>

        <div class="sub-tab-content hidden" data-type="calendar">
            <div class="card">
                <h3>Programma Ripassi</h3>
                <div id="calendarList"></div>
            </div>
        </div>

        <div class="sub-tab-content hidden" data-type="history">
            <div class="card">
                <h3>Gestione Argomenti</h3>
                <div class="historyList"></div>
            </div>
            <div class="card">
                <h3>üíæ Backup e Ripristino</h3>
                <button class="btn" style="background:#7f8c8d" onclick="exportData()">Esporta Database (JSON)</button>
                <button class="btn" style="background:var(--success); margin-top:10px;" onclick="document.getElementById('importFile').click()">Importa Database</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
            </div>
        </div>
    </div>
</div>

<script>
    let data = JSON.parse(localStorage.getItem('multiSubjectDataV6')) || { subjects: {}, activeSubject: null };

    function save() { localStorage.setItem('multiSubjectDataV6', JSON.stringify(data)); }

    function promptNewSubject() {
        const name = prompt("Nome della materia:");
        if (name && !data.subjects[name]) {
            data.subjects[name] = { topics: [] };
            data.activeSubject = name;
            save(); render();
        }
    }

    function render() {
        const bar = document.getElementById('subjectBar');
        bar.innerHTML = '<button class="add-subject-btn" onclick="promptNewSubject()">+</button>';
        Object.keys(data.subjects).forEach(sub => {
            const btn = document.createElement('div');
            btn.className = `subject-tab ${data.activeSubject === sub ? 'active' : ''}`;
            btn.innerHTML = `${sub} <span class="edit-sub-btn" onclick="editSubject('${sub}')">‚öôÔ∏è</span>`;
            btn.onclick = (e) => { if(e.target.className !== 'edit-sub-btn') { data.activeSubject = sub; save(); render(); } };
            bar.appendChild(btn);
        });

        const content = document.getElementById('appContent');
        if (!data.activeSubject) {
            document.getElementById('noSubject').classList.remove('hidden');
            return;
        }
        document.getElementById('noSubject').classList.add('hidden');
        
        const template = document.getElementById('subjectTemplate').cloneNode(true);
        template.classList.remove('hidden');
        template.id = "activeView";
        content.innerHTML = "";
        content.appendChild(template);
        renderSubjectData();
    }

    function renderSubjectData() {
        const sub = data.subjects[data.activeSubject];
        const today = new Date().toISOString().split('T')[0];
        
        const ripassoList = document.querySelector('.ripassoList');
        const due = sub.topics.filter(t => t.next <= today);
        ripassoList.innerHTML = due.length ? "" : "<p style='text-align:center; color:grey;'>Tutto ripassato!</p>";
        due.forEach(t => {
            ripassoList.innerHTML += `
                <div class="card" style="border-left:4px solid var(--accent)">
                    <strong>${t.name}</strong>
                    <div class="valutazione-grid">
                        <button class="btn btn-valutazione" style="background:#7f8c8d" onclick="rateTopic('${t.id}', 0)">Rifai</button>
                        <button class="btn btn-valutazione" style="background:var(--danger)" onclick="rateTopic('${t.id}', 1)">Diff.</button>
                        <button class="btn btn-valutazione" style="background:var(--accent)" onclick="rateTopic('${t.id}', 2)">Buono</button>
                        <button class="btn btn-valutazione" style="background:var(--success)" onclick="rateTopic('${t.id}', 3)">Facile</button>
                    </div>
                </div>`;
        });

        const calList = document.getElementById('calendarList');
        const schedule = {};
        sub.topics.forEach(t => { schedule[t.next] = (schedule[t.next] || 0) + 1; });
        calList.innerHTML = Object.keys(schedule).sort().map(date => `
            <div class="calendar-row">
                <span>${date.split('-').reverse().join('/')}</span>
                <span style="font-weight:bold; color:var(--accent)">${schedule[date]} argomenti</span>
            </div>
        `).join('') || "Nessuna data programmata.";

        const historyList = document.querySelector('.historyList');
        historyList.innerHTML = sub.topics.map(t => `
            <div class="history-item">
                <strong>${t.name}</strong>
                <div style="font-size:0.7rem; color:grey">Prossimo ripasso: ${t.next}</div>
                <div class="history-controls"><span class="control-link del" onclick="deleteTopic('${t.id}')">Elimina</span></div>
            </div>
        `).join('') || "Vuoto.";
    }

    function addTopic() {
        const input = document.querySelector('.topicInput');
        if (!input.value) return;
        data.subjects[data.activeSubject].topics.push({
            id: Date.now().toString(),
            name: input.value,
            next: shiftDate(new Date().toISOString().split('T')[0], 1),
            interval: 1
        });
        input.value = ""; save(); render();
    }

    function rateTopic(id, q) {
        const sub = data.subjects[data.activeSubject];
        const t = sub.topics.find(x => x.id === id);
        const gaps = [0, 1, 3, 7];
        t.interval = (q === 0) ? 1 : t.interval + gaps[q];
        t.next = shiftDate(new Date().toISOString().split('T')[0], (q === 0 ? 0 : t.interval));
        save(); render();
    }

    function shiftDate(dateStr, days) {
        let d = new Date(dateStr);
        d.setDate(d.getDate() + days);
        return d.toISOString().split('T')[0];
    }

    function switchSubTab(el, type) {
        document.querySelectorAll('.inner-nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelector(`.sub-tab-content[data-type="${type}"]`).classList.remove('hidden');
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `backup_studio_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    }

    function importData(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                data = JSON.parse(e.target.result);
                save(); render();
                alert("Database ripristinato!");
            } catch(err) { alert("Errore nel file."); }
        };
        reader.readAsText(event.target.files[0]);
    }

    function deleteTopic(id) {
        if(confirm("Eliminare?")) {
            data.subjects[data.activeSubject].topics = data.subjects[data.activeSubject].topics.filter(x => x.id !== id);
            save(); render();
        }
    }

    function editSubject(oldName) {
        event.stopPropagation();
        if(confirm("Eliminare la materia " + oldName + "?")) {
            delete data.subjects[oldName];
            data.activeSubject = Object.keys(data.subjects)[0] || null;
            save(); render();
        }
    }

    function applyImprevisto() {
        const sub = data.subjects[data.activeSubject];
        const today = new Date().toISOString().split('T')[0];
        sub.topics.forEach(t => { if(t.next <= today) t.next = shiftDate(t.next, 1); });
        save(); render();
    }

    render();
</script>
</body>
</html>
